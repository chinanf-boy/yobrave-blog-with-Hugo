---
title: "å°çš„Rustç»“æ„ç±»å‹,åº”ä½¿ç”¨å¤åˆ¶è¿˜æ˜¯å€Ÿç”¨ä¼ é€’?(è¯‘)"
date: 2019-09-02T10:11:45+08:00
categories: ["Rust"]
tags: ["copy", "borrow", "struct"]
description: "å¤åˆ¶è¿˜æ˜¯å€Ÿç”¨ä¼ é€’ï¼Œè¿™æ˜¯ä¸€ä¸ªé—®é¢˜"
css: ["/css/main.css", "/css/stylesheet.css"]
draft: false
---

![ ](https://www.forrestthewoods.com/blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/assets/img/header.png)

# å¯¹äºå°çš„ Rust ç»“æ„ç±»å‹ï¼Œåº”ä½¿ç”¨å¤åˆ¶ï¼ˆcopyï¼‰è¿˜æ˜¯å€Ÿç”¨(borrow)ä¼ é€’ï¼Ÿ

2019 å¹´ 8 æœˆ 26 æ—¥ â¤ï¸ [åŸæ–‡](https://www.forrestthewoods.com/blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow)

åƒè®¸å¤šå¥½æ•…äº‹ä¸€æ ·ï¼Œè¿™ä¸ªæ•…äº‹ä»ä¸€ä¸ªç®€å•çš„é—®é¢˜å¼€å§‹ã€‚å¯¹äºå°çš„ Rust ç»“æ„ç±»å‹ï¼Œåº”ä½¿ç”¨å¤åˆ¶è¿˜æ˜¯å€Ÿç”¨ä¼ é€’ï¼Ÿä¾‹å¦‚ï¼š

```rust
struct Vector3 {
    x: f32,
    y: f32,
    z: f32
}

fn dot_product_by_copy(a: Vector3, b: Vector3) -> float {
    a.x*b.x + a.y*b.y + a.z*b.z
}

fn dot_product_by_borrow(a: &Vector3, b: &Vector3) -> float {
    a.x*b.x + a.y*b.y + a.z*b.z
}
```

å°±æ˜¯è¿™ä¸ªç®€å•çš„é—®é¢˜å°†æˆ‘å¸¦å‘äº†é•¿å¾ä¹‹è·¯ï¼Œå¸¦æœ‰äº›æƒŠäººçš„æ›²æŠ˜å’Œå‘ç°ã€‚

## ä¸ºä»€ä¹ˆè¿™ä¸ªé—®é¢˜æ˜¯é‡è¦çš„å‘¢

è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæœ‰ä¸¤ä¸ªåŸå› ï¼šæ€§èƒ½å’Œäººä½“å·¥ç¨‹å­¦ã€‚

### æ€§èƒ½

é€šè¿‡å¤åˆ¶ä¼ é€’å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦æ¯ä¸ª`Vector3`å¤åˆ¶ 12 ä¸ªå­—èŠ‚(3 ä¸ª f32 ç±»å‹)ã€‚ è‹¥æ˜¯é€šè¿‡ borrow ä¼ é€’ï¼Œé‚£ä¹ˆæ¯ä¸ª`Vector3`å°±æ˜¯ä¸€ä¸ª 8 å­—èŠ‚çš„æŒ‡é’ˆï¼ˆåœ¨ 64 ä½ä¸Šï¼‰ã€‚å…¶å®ä¸¤è€…å¾ˆæ¥è¿‘ï¼Œä¹Ÿè®¸å¯¹æ€§èƒ½æ¥è¯´æ— å…³ç´§è¦ã€‚

ä½†æ˜¯å¦‚æœæˆ‘ä»¬`f32`æ”¹ä¸º`f64`ï¼Œç°åœ¨å®ƒä¸€ä¸ªç±»å‹ï¼Œæ‰€å çš„å¤§å°å°±æ˜¯ 8 å­—èŠ‚ï¼ˆå€Ÿç”¨ï¼‰å¯¹ 24 å­—èŠ‚ï¼ˆå¤åˆ¶ï¼‰ã€‚è€Œå¯¹äºä½¿ç”¨`Vector4`çš„ä»£ç ï¼Œå°±æœ‰ 4 ä¸ª`f64`ï¼Œé‚£ä¹ˆæˆ‘ä»¬çªç„¶å°±å‡åˆ° 8 å­—èŠ‚å¯¹ 32 å­—èŠ‚ã€‚

### äººä½“å·¥ç¨‹å­¦

åœ¨ C++ä¸­ï¼Œæˆ‘ç¡®åˆ‡åœ°çŸ¥é“å¦‚ä½•å†™è¿™ä¸ªã€‚

````c++
struct Vector3 {
    float x;
    float y;
    float z;
};

float dot_product(Vector3 const& a, Vector3 const& b) {
    return a.x*b.x + a.y*b.y + a.z*b.z
}

ç®€å•ç‚¹ã€‚é€šè¿‡å¸¸é‡(const)å¼•ç”¨ï¼Œå¹¶æŒ‰è¦æ±‚è°ƒç”¨å°±å¥½äº†ã€‚

Rustçš„é—®é¢˜æ˜¯äººä½“å·¥ç¨‹å­¦ã€‚å½“ä»¥å¤åˆ¶ä¼ é€’æ—¶ï¼Œæ‚¨å¯ä»¥å°†æ•°å­¦è¿ç®—æ¸…æ™°è€Œç®€å•åœ°ç»„åˆåœ¨ä¸€èµ·ã€‚

```rust
fn do_math(p1: Vector3, p2: Vector3, d1: Vector3, d2: Vector3, s: f32, t: f32) -> f32 {
    let a = p1 + s*d1;
    let b = p2 + s*d2;
    dot_product(b - a, b - a)
}
````

ç„¶è€Œï¼Œå½“ä½¿ç”¨å€Ÿç”¨è¯­ä¹‰æ—¶ï¼Œå®ƒä¼šå˜æˆä¸€å›¢ä¸‘é™‹çš„æ··ä¹±ï¼š

```rust
fn do_math(p1: &Vector3, p2: &Vector3, d1: &Vector3, d2: &Vector3, s: f32, t: f32) -> f32 {
    let a = p1 + &(&d1*s);
    let b = p2 + &(&d2*t);
    let result = dot_product(&(&b - &a), &(&b - &a));
}
```

å‘•ï¼è¦æ˜ç¡®å€Ÿç”¨ä¸´æ—¶å€¼çš„å†™æ³•è®©äºº ğŸ¤®ã€‚

## å»ºç«‹åŸºå‡†

æ‰€ä»¥ï¼ŒRust åº”è¯¥ä¼ é€’å°ç»“æ„ï¼Œæ¯”å¦‚`Vector3`ï¼Œç”¨å¤åˆ¶è¿˜æ˜¯å€Ÿç”¨ï¼Ÿ

Twitterï¼ŒReddit æˆ– StackOverflow éƒ½æ²¡æœ‰å¾—åˆ°å¾ˆå¥½çš„ç­”æ¡ˆã€‚æˆ‘æ£€æŸ¥äº†åƒ nalgebraï¼ˆå€Ÿç”¨ï¼‰å’Œ cgmathï¼ˆæŒ‰å€¼ï¼‰çš„æµè¡Œç®±å­ï¼Œå‘ç°ä¸¤ç§æ–¹å¼éƒ½å¾ˆå¸¸è§ã€‚

æˆ‘ä¸å–œæ¬¢å€Ÿç”¨çš„äººä½“å·¥ç¨‹å­¦ã€‚ä½†æ€§èƒ½å‘¢ï¼Ÿå¦‚æœå¤åˆ¶é€Ÿåº¦å¾ˆå¿«ï¼Œé‚£ä¹ˆè¿™ä¸€åˆ‡éƒ½ä¸é‡è¦ã€‚æ‰€ä»¥æˆ‘åšäº†å”¯ä¸€åˆç†çš„äº‹æƒ…ã€‚æˆ‘å»ºç«‹äº†ä¸€ä¸ªåŸºå‡†ï¼

æˆ‘æƒ³è¦æµ‹è¯•ä¸€äº›ä¸œè¥¿ï¼Œç¨å¾®å¤šè¿‡åŸå§‹æ“ä½œæ€§èƒ½æµ‹è¯•ã€‚è™½å®ƒä»ç„¶æ˜¯ä¸€ä¸ªæ„šè ¢çš„ç»¼åˆåŸºå‡†ï¼Œä¸èƒ½ä»£è¡¨çœŸæ­£çš„åº”ç”¨ç¨‹åºã€‚ä½†è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚è¿™é‡Œ*å¤§è‡´*ç»™å‡ºæˆ‘æƒ³åˆ°çš„ã€‚

```rust
let num_shapes = 4000;
for cycle in 0...5 {
    let (spheres, capsules, segments, triangles) = generate_shapes(num_shapes);
    for run in 0..5 {
        for (a,b) in collision_pairs {
            test_by_copy(a,b)
        }
        for pair in collision_pairs {
            test_by_borrow(&a, &b)
        }
    }
}
```

æˆ‘éšæœºç”Ÿæˆ 4000 ä¸ª spheres, capsules, segments, å’Œ trianglesã€‚ç„¶åï¼Œæˆ‘å¯¹æ‰€æœ‰ SphereSphereï¼ŒSphereCapsuleï¼ŒCapsuleCapsule å’Œ SegmentTriangle ä¸¤ä¸¤é…å¯¹ï¼Œæ¥ä¸ªç®€å•é‡å æµ‹è¯•ã€‚è¿™äº›æµ‹è¯•æ˜¯å¯¹åº”å¤åˆ¶å’Œå€Ÿç”¨ä¼ é€’ã€‚åœ¨æµ‹è¯•`test_by_copy`å’Œ`test_by_borrow`ä¸­ï¼Œåªè®¡ç®—æ—¶é—´ã€‚

æ¯ä¸ªå®Œæ•´çš„åŸºå‡†æµ‹è¯•æ‰§è¡Œ 32 äº¿æ¬¡æ¯”è¾ƒï¼Œå‘ç°çº¦ 2.2 äº¿ä¸ªé‡å å¯¹ã€‚ä»¥ä¸‹æ˜¯åœ¨æˆ‘å¼ºå¤§çš„ i7-8700k Windows æ¡Œé¢ä¸Šï¼Œå•çº¿ç¨‹è¿è¡Œçš„ä¸€äº›ç»“æœã€‚æ‰€æœ‰æ—¶é—´éƒ½ä»¥æ¯«ç§’ä¸ºå•ä½ã€‚

```
Â Â Rust
Â Â Â Â f32 by-copy: Â Â 7,109
Â Â Â Â f32 by-borrow: 7,172 (0.88% slower)

Â Â Â Â f64 by-copy: Â Â 9,642
Â Â Â Â f64 by-borrow: 9,601 (0.42% faster)
```

å—¯ï¼Œè¿™æœ‰ç‚¹ä»¤äººæƒŠè®¶ã€‚é€šè¿‡å¤åˆ¶æˆ–é€šè¿‡å€Ÿç”¨å‡ ä¹æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼è¿™äº›ç»“æœéå¸¸ä¸€è‡´ã€‚è™½ç„¶æœ‰å°äº 1ï¼…çš„å·®å¼‚ï¼Œå®Œå…¨åœ¨è¯¯å·®èŒƒå›´å†…ã€‚

è¿™æ˜¯æˆ‘ä»¬é—®é¢˜çš„ç­”æ¡ˆå—ï¼Ÿæˆ‘ä»¬åº”è¯¥å¤åˆ¶ä¼ é€’å°±å¥½äº†å—ï¼Ÿæˆ‘è¿˜æ²¡é‚£ä¹ˆå¿«ä¸‹å®šè®ºã€‚

## éšæˆ‘æ¥åˆ° C ++ Rabbit Hole

åœ¨æˆ‘æœ€åˆçš„ Rust åŸºå‡†æµ‹è¯•ä¹‹åï¼Œæˆ‘å†³å®šå°†æˆ‘çš„æµ‹è¯•å¥—ä»¶ç§»æ¤åˆ° C ++ ã€‚ä»£ç ç±»ä¼¼ï¼Œä½†ä¸å®Œå…¨ç›¸åŒã€‚Rust å’Œ C ++ çš„ä»£ç å®ç°éƒ½æ˜¯æˆ‘è®¤ä¸ºåœ¨å„è‡ªè¯­è¨€ä¸­å¸¸ç”¨æ–¹å¼çš„ã€‚

```
Â Â C++
Â Â Â Â f32 by-copy: Â Â 14,526
Â Â Â Â f32 by-borrow: 13,880 (4.5% faster)

Â Â Â Â f64 by-copy: Â Â 13,439
Â Â Â Â f64 by-borrow: 13,942 (3.8% slower)
```

ç­‰ç­‰ï¼Œä»€ä¹ˆï¼Ÿï¼è‡³å°‘æœ‰ä¸¤ä»¶äº‹æƒ…åœ¨è¿™é‡Œéå¸¸å¥‡æ€ªã€‚

1.  `double`(f64)æŒ‰å€¼ä¼ é€’æ˜¯*å¿«*è¿‡`float`æŒ‰å€¼ä¼ é€’
2.  C ++ `float`æ¯” Rust çš„`f32`æ…¢äº†ä¸¤å€

### å†…è”

æ˜¾ç„¶ï¼Œå‘ç”Ÿäº†ä¸€äº›æ„å¤–ã€‚ä½¿ç”¨ Visual Studio 2019ï¼Œè®©æˆ‘æ¥ä¸€æŠŠå¿«é€Ÿ CPU æ€§èƒ½åˆ†æï¼ˆCPU Profilesï¼‰ã€‚

![Visual Studio Benchmark C++ Result](https://www.forrestthewoods.com/blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/assets/img/01.png)

C ++ åˆ†æ

![Visual Studio Benchmark Rust Result](https://www.forrestthewoods.com/blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/assets/img/02.png)

Rust åˆ†æ

å•Šå“ˆï¼Rust çœ‹èµ·æ¥å‡ ä¹éƒ½åœ¨å†…è”ã€‚è®©æˆ‘ä»¬å¤åˆ» Rustï¼Œå¹¶åœ¨æˆ‘ä»¬çš„ C ++ å®ç°ä¹‹å‰ï¼Œæ‰”å‡ºä¸€å‘å¼ºåŠ›çš„`__forceinline`ã€‚

```
Â Â C++ w/ inlining
Â Â Â Â f32 by-copy: Â Â 12,688
Â Â Â Â f32 by-borrow: 12,108 (4.5% faster)

Â Â Â Â f64 by-copy: Â Â 11,860
Â Â Â Â f64 by-borrow: 11,967 (0.9% slower)
```

å†…è” C ++ æä¾›äº†å¤§çº¦ 12ï¼…çš„æå‡ã€‚ä½†`double`ä»ç„¶æ¯”`float`å¿«ã€‚C ++ ä»ç„¶æ¯” Rust æ…¢ã€‚

### åˆ«å

æˆ‘è®¤ä¸ºæˆ‘çš„ C ++ å’Œ Rust å®ç°éƒ½æ˜¯å¸¸è§ç”¨æ³•ã€‚ç„¶è€Œä»–ä»¬æ˜¯ä¸åŒçš„ï¼å½“ Rust è¿”å›ä¸€ä¸ªå…ƒç»„æ—¶ï¼ŒC ++ åˆ™æ˜¯é€šè¿‡å¼•ç”¨å–å‡ºå‚æ•°ã€‚è¿™æ˜¯å› ä¸º Rust å…ƒç»„çš„ä½¿ç”¨ä»¤äººæ„‰å¿«ï¼Œè€Œ C ++ å…ƒç»„æ˜¯ä¸€ä¸ªæ€ªç‰©ã€‚ä½†æˆ‘ç¦»é¢˜äº†ã€‚

```rust
// Rust
fn closest_pt_segment_segment(p1: Vector3, q1: Vector3, p2: Vector3, q2: Vector3)
-> (T, T, T, Vector3, Vector3)
{
    // Do math
}
```

```c++
// C++
float closest_pt_segment_segment(
    Vector3 p1, Vector3 q1, Vector3 p2, Vector3 q2,
    float& s, float& t, Vector3& c1, Vector3& c2)
{
    // Do math
}
```

è¿™ç§å¾®å¦™çš„å·®å¼‚å¯èƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå·¨å¤§å½±å“ã€‚C ++ ç‰ˆæœ¬ç¼–è¯‘å™¨æ— æ³•ç¡®å®šè¾“å‡ºå‚æ•°æ˜¯å¦æœ‰åˆ«åã€‚è¿™å¯èƒ½ä¼šé™åˆ¶å…¶ä¼˜åŒ–èƒ½åŠ›ã€‚åŒæ—¶ Rust ä½¿ç”¨ï¼Œå¹¶è¿”å›å·²çŸ¥ä¸ºéåˆ«åï¼ˆnon-aliasedï¼‰çš„å±€éƒ¨å˜é‡ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œä¿®å¤ä¸Šé¢çš„åˆ«åå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼é€šè¿‡å†…è”çš„æ–¹å¼ï¼Œç¼–è¯‘å™¨å·²ç»å¤„ç†å®ƒã€‚ä»¤æˆ‘æƒŠè®¶çš„æ˜¯ï¼Œä»¥ä¸‹ä»£ç  C ++ å¹¶æ²¡æœ‰å¤„ç†å¥½ï¼š

```c++
void run_test(
    vector<TSphere> const& _spheres,
    vector<TCapsule> const& _capsules,
    vector<TSegment> const& _segments,
    vector<TTriangle> const& _triangles,
    int64_t& num_overlaps,
    int64_t& milliseconds)
{
    // perform overlaps
}
```

æ›´æ”¹`run_test`å‡½æ•°ï¼Œé€‰æ‹©è¿”å›`std::tuple<int64_t, int64_t>`ï¼Œæä¾›äº†ä¸€ä¸ªå°ä½†æ˜æ˜¾çš„æ”¹è¿›ã€‚

```
Â Â C++ w/ inlining, tuples
Â Â Â Â f32 by-copy: Â Â 12,863
Â Â Â Â f32 by-borrow: 11,555 (10.17% faster)

Â Â Â Â f64 by-copy: Â Â 11,832
Â Â Â Â f64 by-borrow: 11,524 (2.60% faster)
```

## ç¼–è¯‘æ ‡å¿—ï¼ˆCompile Flagsï¼‰

æ­¤æ—¶ï¼ŒC ++ å’Œ Rust éƒ½ä½¿ç”¨é»˜è®¤é€‰é¡¹è¿›è¡Œç¼–è¯‘ã€‚Visual Studio èƒ½ç»™å‡ºå¤§é‡çš„æ ‡å¿—ã€‚æˆ‘å°è¯•è°ƒæ•´ä¸€å †æ ‡å¿—æ¥æé«˜æ€§èƒ½ã€‚

- ä»£ç é€Ÿåº¦ä¼˜å…ˆï¼ˆ/Otï¼‰
- ç¦ç”¨å¼‚å¸¸
- é«˜çº§ Vector æ‰©å±• 2ï¼ˆ/arch:AVX2ï¼‰
- æµ®ç‚¹æ¨¡å¼:å¿«é€Ÿï¼ˆ/fp:fastï¼‰
- å¯ç”¨æµ®ç‚¹å¼‚å¸¸:å¦ï¼ˆ/fp:except-ï¼‰
- ç¦ç”¨å®‰å…¨æ£€æŸ¥ /GS-
- æ§åˆ¶æµé˜²æŠ¤: No

å”¯ä¸€èƒ½å¤Ÿäº§ç”ŸçœŸæ­£å·®å¼‚çš„æ ‡å¿—æ˜¯â€œç¦ç”¨å¼‚å¸¸â€å’Œ AVX2ã€‚æ¯ä¸ªçº¦ 10ï¼… æå‡ã€‚åœ¨ä¸ Rust ç¡¬ç¢°ç¡¬çš„å°è¯•ä¸­ï¼Œæˆ‘å†³å®šåœæ­¢ AVX2ã€‚

```
Â Â C++ w/ inlining, tuples, no C++ exceptions
Â Â Â Â f32 by-copy: Â Â 11,651
Â Â Â Â f32 by-borrow: 10,455 (10.27% faster)

Â Â Â Â f64 by-copy: Â Â 10,866
Â Â Â Â f64 by-borrow: 10,467 (3.67% faster)
```

æˆ‘ä»¬å·²ç»è¿›è¡Œäº†ä¸‰æ¬¡ C ++ ä¼˜åŒ–ï¼Œä½†æˆ‘ä»¬ä»ç„¶å­˜åœ¨ä¸¤ä¸ªè°œå›¢ã€‚ä¸ºä»€ä¹ˆæ˜¯`double`æ¯”`float`å¿«ï¼Ÿä¸ºä»€ä¹ˆ C ++ ä»æ¯” Rust æ…¢å¾—å¤šï¼Ÿ

## æ›´æ·±å…¥

æˆ‘è¯•ç€åœ¨[Godbolt](https://godbolt.org/z/1gENA_)å¯¹ä»£ç åæ±‡ç¼–ä¸€ä¸‹ã€‚æ˜¾ç„¶å­˜åœ¨å·®å¼‚ã€‚ä½†æˆ‘ä¸å¤Ÿèªæ˜ï¼Œæ— æ³•é‡åŒ–å®ƒä»¬ã€‚

![Godbolt C++](https://www.forrestthewoods.com/blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/assets/img/03.png)

æ¥ä¸‹æ¥æˆ‘å†³å®šæ•²æ‰“æ•²æ‰“ open VTuneã€‚è€Œè¿™å·®å¼‚ï¼Œä¸€å¤©å°±æ­ç¤ºäº†ï¼

![VTune Rust f32](https://www.forrestthewoods.com/blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/assets/img/04.png)

åˆ†æ”¯é”™è¯¯é¢„æµ‹å¾ˆç³Ÿç³•ã€‚ä¸å¥‡æ€ªã€‚ä»”ç»†æŸ¥çœ‹ Vector Capacity Usageï¼ˆFPUï¼‰ã€‚ä»¥ä¸‹æ˜¯é’ˆå¯¹ä¸åŒæ„å»ºï¼Œè¯¥å€¼çš„æŠ¥å‘Š:

```
Â Â Rust f32Â Â Â  42.3%
Â Â Rust f64Â Â Â  32.7%
Â Â C++Â  floatÂ  12.5%
Â Â C++Â  double 25.0%
```

Yowzaï¼æ— è®ºå‡ºäºä½•ç§åŸå› ï¼Œæˆ‘éƒ½ä¸çŸ¥é“ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼ŒRust åœ¨åˆ©ç”¨ CPU çš„æµ®ç‚¹å‘é‡æ–¹é¢æ•ˆç‡æ›´é«˜ã€‚å·®å¼‚æ˜¯å·¨å¤§çš„ï¼Rust`f32`æ•ˆç‡å‡ ä¹æ˜¯ C ++ `float`çš„ 3.5 å€ã€‚å¹¶ä¸”ï¼Œå‡ºäºæŸç§åŸå› ï¼ŒC ++ `double`æ˜¯`float`æ•ˆç‡çš„ä¸¤å€ï¼ğŸ¤·â™‚ï¸

æ˜¾è€Œæ˜“è§çš„çŒœæµ‹æ˜¯ Rust ç¼–è¯‘å™¨åœ¨è‡ªåŠ¨ Vector åŒ–æ–¹é¢åšå¾—æ›´å¥½ã€‚é‚£ä¹ˆæ•…äº‹åˆ°æ­¤ä¸ºæ­¢äº†å—ï¼Œè¿˜æ˜¯ To be Continuedï¼Ÿæˆ‘è€å®è¯´ä¸çŸ¥é“ã€‚æˆ‘ç°åœ¨å·²å°½å¯èƒ½åœ°æ·±æŒ–ã€‚å¦‚æœæœ‰ä»»ä½•ä¸“å®¶æ„¿æ„æä¾›æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œæˆ‘ä¼šå…¨åŠ›ä»¥èµ´ã€‚

## å¤åˆ¶ä¸å€Ÿç”¨ä¼ é€’

ä¸çŸ¥ä½•æ•…ï¼Œæˆ‘çš„ Rust æ–‡ç« èŠ±äº†æ›´å¤šæ—¶é—´è°ˆè®º C ++ ã€‚ä½†é‚£æ²¡å…³ç³»ï¼

æˆ‘ä»¬çš„åˆæ­¥æµ‹è¯•è¡¨æ˜ï¼Œå¤åˆ¶å’Œå€Ÿç”¨ä¹‹é—´çš„å·®å¼‚ä¸åˆ°ç™¾åˆ†ä¹‹ä¸€ã€‚åœ¨æˆ‘çš„ç»¼åˆæµ‹è¯•ä¸­ï¼Œå…³é”®åŸå› ä¼¼ä¹æ˜¯å› ä¸ºï¼Œå°½ç®¡æˆ‘æ²¡æœ‰ä»»ä½•ä¸€ä¸ª`#[inline]`å®£è¨€/å£°æ˜ï¼ŒRust ä¹Ÿä¼šè‡ªåŠ¨å†…è”ï¼æ­¤å¤–ï¼ŒRust è‡ªåŠ¨ç”Ÿæˆä»£ç çš„é€Ÿåº¦æ˜¯ç±»ä¼¼ C ++ å®ç°çš„ä¸¤å€ã€‚

å¯¹äºå°å‹ Rust ç»“æ„ï¼Œæˆ‘å¯¹å¤åˆ¶ä¸å€Ÿç”¨çš„ç­”æ¡ˆæ˜¯**å¤åˆ¶ä¼ é€’**ã€‚è¿™ä¸ªç­”æ¡ˆæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚

1.  â€œå°â€çš„å®šä¹‰æœªç»æµ‹è¯•ä¸”æœªçŸ¥ã€‚
2.  é‰´äºè¾ƒå°‘çš„è‡ªåŠ¨ Vector åŒ–ï¼Œè¾ƒå°‘çš„æ•°å­¦ç»“æ„å¯èƒ½ä¸ä¼šèµ·ä½œç”¨ã€‚
3.  é«˜æ€§èƒ½å¤åˆ¶ä»£ç å¯èƒ½éœ€è¦å†…è”ï¼Œå’Œè¦å¯¹ç¼–è¯‘å™¨ç›¸å½“ä¿¡ä»»ã€‚ğŸ˜±
4.  åŒ…æ‹¬åœ¨å¦ä¸€ä¸ªç®±å­ä¸­å®ç°çš„å°ç»“æ„æ˜¯æœªç»æµ‹è¯•çš„ã€‚
5.  ç»¼åˆåŸºå‡†å¹¶ä¸åæ˜ ç°å®ä¸–ç•Œã€‚å¸¸è®°æµ‹é‡ï¼

## ç»“è®º

æˆ‘ä»ä¸€ä¸ªç®€å•çš„é—®é¢˜å¼€å§‹ï¼Œç»§ç»­è¿›è¡Œæœ‰è¶£çš„æ•™è‚²ä¹‹æ—…ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘å°†ç»§ç»­é€šè¿‡å¤åˆ¶ä¼ é€’å°ç»“æ„ã€‚è™½è¯´åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œæˆ‘éƒ½ä¸æ˜¯ 100ï¼…ç¡®ä¿¡å®ƒæ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚ä½†æ˜¯æˆ‘è¦ä¸º Vector æ•°å­¦åº“è½¬èº«ã€‚

æˆ‘æ€€ç–‘ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼Œå³æ€§èƒ½ä¸ä½³ã€‚æˆ‘å»ºè®®è°¨æ…ä¹è§‚ã€‚ç›¸ä¿¡ç¼–è¯‘å™¨åšå‡ºæ­£ç¡®çš„å†³å®š...ä½†è¦éªŒè¯æ‚¨çš„çœŸå®åœºæ™¯ã€‚

è°¢è°¢é˜…è¯»ã€‚

## æºä»£ç 

æˆ‘çš„åŸºå‡†æµ‹è¯•çš„å®Œæ•´æºä»£ç å¯ç”¨ã€‚

[FullProjects.zip](https://www.forrestthewoods.com/blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/assets/data/fts_small_struct_bench.zip)

**Rust**\
[main.rs](https://www.forrestthewoods.com//blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/rust_main)\
[by_copy.rs](https://www.forrestthewoods.com//blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/rust_by_copy)\
[by_borrow.rs](https://www.forrestthewoods.com//blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/rust_by_borrow)

**C++**\
[main.cpp](https://www.forrestthewoods.com//blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/cpp_main)\
[by_value.cpp](https://www.forrestthewoods.com//blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/cpp_by_value)\
[by_ref CPP](https://www.forrestthewoods.com//blog/should-small-rust-structs-be-passed-by-copy-or-by-borrow/cpp_by_ref)

## Clang

ä¸Šé¢æ‰€æœ‰çš„ C++åŸºå‡†éƒ½æ˜¯ä½¿ç”¨ VisualStudio 2019 ä¸­çš„ MSVC æ„å»ºé“¾å®Œæˆçš„ã€‚æˆ‘æƒ³çŸ¥é“ Clang æ˜¯å¦èƒ½åšå¾—æ›´å¥½ã€‚æŒ‰å€¼è®¡ç®—ï¼Œé€Ÿåº¦è¦å¿«ä¸€ç‚¹ã€‚ä½†å®ƒåœ¨å¤„ç†å¼•ç”¨ä¼ é€’çš„ doubles æ–¹é¢åšå¾—éå¸¸å·®ã€‚

```
Â Â C++ (Clang) w/ inlining, tuples, no C++ exceptions
Â Â Â Â f32 by-copy: Â Â 10416
Â Â Â Â f32 by-borrow: 10072 (3.30% faster)

Â Â Â Â f64 by-copy: Â Â 10520
Â Â Â Â f64 by-borrow: 11335 (7.47% slower)
```

æ‰€æœ‰è¿™äº›ä»£ç éƒ½å¯ä»¥ä¼˜åŒ–ä¸ºæ›´å¥½ã€‚åº”è¯¥æœ‰å¯èƒ½å¾—åˆ° C++å’Œ Rust åˆ°å®Œå…¨ç›¸åŒçš„æ°´å¹³ã€‚ä½†è¿™è¶…å‡ºäº†æœ¬æ–‡èŒƒå›´ä¸æˆ‘æœ€åˆçš„é—®é¢˜ã€‚

Forrest SmithÂ©2019 å¹´ã€‚ç‰ˆæƒæ‰€æœ‰ã€‚
